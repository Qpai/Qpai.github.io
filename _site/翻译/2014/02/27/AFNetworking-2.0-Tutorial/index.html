
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Afnetworking 2.0 Tutorial</title>
    
    <meta name="author" content="Qpai">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">清凉派的博客</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>Afnetworking 2.0 Tutorial </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>27 February 2014</span>
    </div>
    <div class="content">
      

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 5.4.3 (402231)"/><meta name="author" content="李祎"/><meta name="created" content="2014-02-19 05:57:01 +0000"/><meta name="updated" content="2014-02-21 07:21:47 +0000"/><title>AFNetworking 2.0 Tutorial（翻译）</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;"><span style="-evernote-last-insertion-point:true;"/>AFNetworking 2.0 Tutorial</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><a href="http://www.raywenderlich.com/59255/afnetworking-2-0-tutorial" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">原文链接</a></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在iOS 7中，苹果新引入了NSURLSession，作为网络请求的方法的首选.来替代NSURLConnection这个api。使用新的NSURLSession接口在网络开发中是一个非常有效的方式。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">然而，还有另外一种选择，使用非常流行的第三方框架AFNetworking。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">最新的版本AFNetworking 2.0被构建在NSURLSession上面，所以你可以使用所有NSURLSession提供的很棒的特性。而且你也得到了很多额外的很酷的属性，比如序列化，网络状态的支持，UIKit的扩展(比如方便UIImageView异步加载图片的categry)。等</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">AFNetworking是难以置信的流行--它赢得了读者评选的2012年iOS最佳工具库大奖，它也是使用的最广泛的开源项目之一，在Github上面已经有了超过10000个star,2600个fork,160个构建者。<br/>
在本教程中，我们会通过获取<a href="http://www.worldweatheronline.com/free-weather-feed.aspx" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">World Weather Online</a>的数据来构建一个天气app，在这个过程中，会学到AFNetworking 的主要模块。你会从静态天气数据开始，最终获取完整的在线数据。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">今日预测：一个很酷的程序员学习了所有关于AFNetworking 的内容，并且应用于他/她的apps中。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">Getting Started</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">先在这里下载这个教程用到的项目<a href="http://cdn1.raywenderlich.com/wp-content/uploads/2014/01/WeatherStarter.zip" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">here</a>。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个项目提供了基本的UI让你开始。还没增加AFNetworking的代码。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">打开MainStoryboard.storyboard，你会看到这三个ViewControllers<img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/e36dcd8bf8d5795aac56f9fa8eaf9fec.png" height="381" width="700"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">从左到右分别是：</p>
<ul style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">顶层导航控制器。</li>
<li style="line-height: 22px;">显示天气列表的视图控制器，一天一行。</li>
<li style="line-height: 22px;">一个自定义的视图控制器，用来在用户点单行cell的时候显示单独一天的天气信息。</li>
</ul>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">构建并运行这个项目，你会看到UI出现，但是没有任何工作，因为应用还需要从网络上面得到数据，而你什么代码都没写呢。这就是我们这篇教程正在做的事情。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">首先第一件事，就是在你的项目中引入AFNetworking框架。在<a href="http://www.github.com/" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">GitHub</a>上面点击下载链接，下载最新版本的AFNetworking。当我们解压文件，我们会看到一些文件和子文件夹。它包括一个叫AFNetworking的文件夹和一个叫UIKit+AFNetworking的文件夹，如下图所示：<img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/3e0ebd4f41e2b70955e7577aefb3d37c.png" height="500" width="512"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">拖动这两个文件夹到你的Xcode项目中。<img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/288e3dea90d74b6e545fd0588ad72434.png" height="396" width="700"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">增加文件夹的时候会提示一些选项，请确保Copy items into destination group’s folder (if needed) 和 Create groups for any added folders被勾选。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">完成之后，打开你项目中Supporting Files部分下的预编译头Weather-Prefix.pch，在其他导入后面增加下面一行：<br/>
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">#import "AFNetworking.h"</code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在预编译头中导入AFNetworking，意味着框架会自动在所有项目源代码中被引入。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">很简单对吗？？现在我们就开始写天气的代码吧。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">Operation JSON</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">AFNetworking在加载和解析从网络上面读取数据的结构方面足够聪明，甚至是老的请求，特别是它支持JSON,XML,Plist。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">你可以下载一些JSON,然后通过一个解析器（比如NSJSONSerialization），自己运行它，但是何必呢，AFNetworking可以把事情全帮你搞定。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/f7452f7377de06004f79a0bbc25cd655.png" height="194" width="303"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">首先，你需要一个测试脚本的base url，把它写在WTTableViewController.m最上面，就是所有<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">#import</code> 行的下面。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">static NSString * const BaseURLString = @"<a href="http://www.raywenderlich.com/demos/weather_sample/">http://www.raywenderlich.com/demos/weather_sample/</a>";</code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个地址来自我为这个教程生成的“web service”的接口。如果你想知道它长什么样，你可以从<a href="http://cdn3.raywenderlich.com/downloads/weather_sample.zip" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">这里</a>下载。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个web服务返回了三种不同格式（JSON,XML,Plist）的天气数据，你可以通过下面的url查看返回的数据：</p>
<ul style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;"><a href="http://www.raywenderlich.com/demos/weather_sample/weather.php?format=json" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">http://www.raywenderlich.com/demos/weather_sample/weather.php?format=json</a></li>
<li style="line-height: 22px;"><a href="http://www.raywenderlich.com/demos/weather_sample/weather.php?format=xml" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">http://www.raywenderlich.com/demos/weather_sample/weather.php?format=xml</a></li>
<li style="line-height: 22px;"><a href="http://www.raywenderlich.com/demos/weather_sample/weather.php?format=plist" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">http://www.raywenderlich.com/demos/weather_sample/weather.php?format=plist</a> （可能在浏览器上不能正确展示）</li>
</ul>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">第一个数据格式，我们用JSON,JSON是一种常用的js对象格式，看起来想下面这样：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">{
    "<span style="color: teal;">data</span>": {
        "<span style="color: teal;">current_condition</span>": [
            {
                "<span style="color: teal;">cloudcover</span>": <span style="color: rgb(221, 17, 68);">"16"</span>,
                "<span style="color: teal;">humidity</span>": <span style="color: rgb(221, 17, 68);">"59"</span>,
                "<span style="color: teal;">observation_time</span>": <span style="color: rgb(221, 17, 68);">"09:09 PM"</span>,
            }
        ]
    }
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">如果你想更深入研究JSON,请学习我们的这篇文章<a href="http://www.raywenderlich.com/5492/working-with-json-in-ios-5" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">Working with JSON Tutorial.</a></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当用户点击JSON按钮，应用就会从服务器上面加载处理JSON数据。在WTTableViewController.m里，找到jsonTapped:(应该是空方法)，用下面的代码替换它：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (IBAction)jsonTapped:(id)sender
{
    <span style="color: rgb(0, 153, 38);">//</span> <span style="color: rgb(0, 153, 153);">1</span>
    NSString <span style="color: teal;">*string</span> = [NSString stringWithFormat:<span style="color: teal;">@"</span><span style="color: teal;">%@</span>weather.php?<span style="font-weight: 700;">format</span>=json<span style="color: rgb(221, 17, 68);">", BaseURLString];
    NSURL <span style="color: teal;">*url</span> = [NSURL URLWithString:string];
    NSURLRequest <span style="color: teal;">*request</span> = [NSURLRequest requestWithURL:url];

    // 2
    AFHTTPRequestOperation <span style="color: teal;">*operation</span> = [[AFHTTPRequestOperation alloc] initWithRequest:request];
    operation.responseSerializer = [AFJSONResponseSerializer serializer];

    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, id responseObject) {

        // 3
        self.weather = (NSDictionary <span style="color: teal;">*)</span>responseObject;
        self.title = <span style="color: teal;">@"</span>JSON Retrieved"</span>;
        [self.tableView reloadData];

    } failure:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, NSError <span style="color: teal;">*error</span>) {

        <span style="color: rgb(0, 153, 38);">//</span> <span style="color: rgb(0, 153, 153);">4</span>
        UIAlertView <span style="color: teal;">*alertView</span> = [[UIAlertView alloc] initWithTitle:<span style="color: teal;">@"</span>Error Retrieving Weather<span style="color: rgb(221, 17, 68);">"
                                                            message:[error localizedDescription]
                                                           delegate:nil
                                                  cancelButtonTitle:<span style="color: teal;">@"</span>Ok"</span>
                                                  otherButtonTitles:nil];
        [alertView show];
    }];

    <span style="color: rgb(0, 153, 38);">//</span> <span style="color: rgb(0, 153, 153);">5</span>
    [operation start];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">太帅了，这就是你的第一个AFNetworking 的代码。由于这是全新的代码，所以我会解释一下。</p>
<ol style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">首先，你通过base url 生成了完整的url地址，这通常是生成一个NSURL 对象，然后用来生成NSURLRequest。</li>
<li style="line-height: 22px;">AFHTTPRequestOperation是一个处理http转换到网络的一体化的类，你通过设置解析器为json解析器来告诉系统按照json的方式来解析反馈的数据。AFNetworking会帮你解析json数据。</li>
<li style="line-height: 22px;">当请求成功之后，success的block将会被调用。JSON序列化工具将会把返回的数据中的responseObject解析为NSDictory。</li>
<li style="line-height: 22px;">如果请求失败，错误的block将会被调用。比如没有网络的情况。你可以显示一个有错误信息的提示。</li>
<li style="line-height: 22px;">你必须明确的告诉opertion执行start，否则什么都不会发生。</li>
</ol>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">正如你看到的，AFNetworking使用起来极其简单。只需几行代码，就可以生成一个网络opertion，包括下载和解析。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">现在天气数据被保存在了self.weather中，你需要显示它。找到tableView:numberOfRowsInSection:方法，并用下面代码替换它：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    <span style="font-weight: 700;">if</span>(!<span style="font-weight: 700;">self</span>.weather)
        <span style="font-weight: 700;">return</span> <span style="color: rgb(0, 153, 153);">0</span>;

    <span style="font-weight: 700;">switch</span> (section) {
        <span style="font-weight: 700;">case</span> <span style="color: rgb(0, 153, 153);">0</span>: {
            <span style="font-weight: 700;">return</span> <span style="color: rgb(0, 153, 153);">1</span>;
        }
        <span style="font-weight: 700;">case</span> <span style="color: rgb(0, 153, 153);">1</span>: {
            NSArray *upcomingWeather = [<span style="font-weight: 700;">self</span>.weather upcomingWeather];
            <span style="font-weight: 700;">return</span> [upcomingWeather count];
        }
        <span style="font-weight: 700;">default</span>:
            <span style="font-weight: 700;">return</span> <span style="color: rgb(0, 153, 153);">0</span>;
    }
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个表单视图被分为了两部分，上面显示当前天气，下面显示未来天气。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">“等等”，你可能会想，<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">[self.weather upcomingWeather]</code>是什么东西？如果<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">self.weather</code>是单纯的字典，那它怎么知道upcomingWeather是什么？</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">为了更简单的显示数据，我给NSDictory增加了一些工具categry。</p>
<ul style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">NSDictionary+weather</li>
<li style="line-height: 22px;">NSDictionary+weather_package</li>
</ul>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这些categry 增加了一些方法为了更简单的获取数据的成员。这让你只需关注网络开发，而非字典键值，对吗？</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">注意：仅供参考，如果你也想实现上面的事情，或者自己实现一个categry，或者使用JSONModel。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">还是在WTTableViewController.m，找到tableView:cellForRowAtIndexPath方法，用下面代码替换：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    <span style="font-weight: 700;">static</span> NSString *CellIdentifier = @<span style="color: rgb(221, 17, 68);">"WeatherCell"</span>;
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier forIndexPath:indexPath];

    NSDictionary *daysWeather = nil;

    <span style="font-weight: 700;">switch</span> (indexPath.section) {
        <span style="font-weight: 700;">case</span> <span style="color: rgb(0, 153, 153);">0</span>: {
            daysWeather = [<span style="font-weight: 700;">self</span>.weather currentCondition];
            <span style="font-weight: 700;">break</span>;
        }

        <span style="font-weight: 700;">case</span> <span style="color: rgb(0, 153, 153);">1</span>: {
            NSArray *upcomingWeather = [<span style="font-weight: 700;">self</span>.weather upcomingWeather];
            daysWeather = upcomingWeather[indexPath.row];
            <span style="font-weight: 700;">break</span>;
        }

        <span style="font-weight: 700;">default</span>:
            <span style="font-weight: 700;">break</span>;
    }

    cell.textLabel.text = [daysWeather weatherDescription];

    <span style="color: rgb(153, 153, 136); font-style: italic;">// You will add code here later to customize the cell, but it's good for now.</span>

    <span style="font-weight: 700;">return</span> cell;
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">就像在tableView:numberOfRowsInSection:中，NSDictory的categry很简单的获取了数据，当前天是字典，未来天气数据是array。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">编译运行你的项目，点击json按钮，请求网络之后，你会看到下面这样：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/25ed2a82a8463f8c9efee4aadf63cdb4.png" height="500" width="352"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">JSON成功了！</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">Operation Property Lists</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">属性列表（或者叫plist）其实就是以一定方式的XML的结构，由苹果定义。苹果把它用于所有类似于用户设置的地方，结构像下面这样：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;"><span style="color: navy;">&lt;dict]]
<![CDATA[>]]>
</span>
  <span style="color: navy;">&lt;key]]
<![CDATA[>]]>
</span>data<span style="color: navy;">&lt;/key]]
<![CDATA[>]]>
</span>
  <span style="color: navy;">&lt;dict]]
<![CDATA[>]]>
</span>
    <span style="color: navy;">&lt;key]]
<![CDATA[>]]>
</span>current_condition<span style="color: navy;">&lt;/key]]
<![CDATA[>]]>
</span>
      <span style="color: navy;">&lt;array]]
<![CDATA[>]]>
</span>
      <span style="color: navy;">&lt;dict]]
<![CDATA[>]]>
</span>
        <span style="color: navy;">&lt;key]]
<![CDATA[>]]>
</span>cloudcover<span style="color: navy;">&lt;/key]]
<![CDATA[>]]>
</span>
        <span style="color: navy;">&lt;string]]
<![CDATA[>]]>
</span>16<span style="color: navy;">&lt;/string]]
<![CDATA[>]]>
</span>
        <span style="color: navy;">&lt;key]]
<![CDATA[>]]>
</span>humidity<span style="color: navy;">&lt;/key]]
<![CDATA[>]]>
</span>
        <span style="color: navy;">&lt;string]]
<![CDATA[>]]>
</span>59<span style="color: navy;">&lt;/string]]
<![CDATA[>]]>
</span>
        ...</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">上面的表现如下：</p>
<ol style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">一个字典以“data”为Key，包含其他字典。</li>
<li style="line-height: 22px;">array由一个叫“current_condition”的字典包含。</li>
<li style="line-height: 22px;">array包含一些键值对，比如cloudcover=16 and humidity=59。</li>
</ol>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">到时候加载plist版本的天气数据了。找到plistTapped:方法，用下面的代码替换空的实现：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (IBAction)plistTapped:(id)sender 
{
    NSString <span style="color: teal;">*string</span> = [NSString stringWithFormat:<span style="color: teal;">@"</span><span style="color: teal;">%@</span>weather.php?<span style="font-weight: 700;">format</span>=plist<span style="color: rgb(221, 17, 68);">", BaseURLString];
    NSURL <span style="color: teal;">*url</span> = [NSURL URLWithString:string];
    NSURLRequest <span style="color: teal;">*request</span> = [NSURLRequest requestWithURL:url];

    AFHTTPRequestOperation <span style="color: teal;">*operation</span> = [[AFHTTPRequestOperation alloc] initWithRequest:request];

    // Make sure to set the responseSerializer correctly
    operation.responseSerializer = [AFPropertyListResponseSerializer serializer];

    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, id responseObject) {

        self.weather = (NSDictionary <span style="color: teal;">*)</span>responseObject;
        self.title = <span style="color: teal;">@"</span>PLIST Retrieved"</span>;
        [self.tableView reloadData];

    } failure:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, NSError <span style="color: teal;">*error</span>) {

        UIAlertView <span style="color: teal;">*alertView</span> = [[UIAlertView alloc] initWithTitle:<span style="color: teal;">@"</span>Error Retrieving Weather<span style="color: rgb(221, 17, 68);">"
                                                            message:[error localizedDescription]
                                                           delegate:nil
                                                  cancelButtonTitle:<span style="color: teal;">@"</span>Ok"</span>
                                                  otherButtonTitles:nil];
        [alertView show];
    }];

    [operation start];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">注意：上面的代码几乎跟json版本的代码一样，除了要把responseSerializer设置为AFPropertyListResponseSerializer，让程序知道，将要解析一个plist数据。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">相当棒的是：你的代码可以支持json或plist，只需改变一丁点的代码就可以实现。编译和运行你的项目，常识点击plist按钮，会出现下面的界面： <img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/28117969bbb37fd3610066f9563d9ae0.png" height="500" width="352"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">顶部导航上的clear按钮会清除标题和列表数据，所以你可以重置数据来确保请求正在进行。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">Operation XML</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">AFNetworking已经帮你解析了json和plist了，解析XML可能会有点复杂。这次你的工作是从XML流中找到天气数据的字典。幸运的是，iOS凭借NSXMLParser 类提供了一些帮助。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">还是在WTTableViewController.m，找到XMLTap:方法，用下面代码进行替换实现：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (IBAction)xmlTapped:(id)sender
{
    NSString <span style="color: teal;">*string</span> = [NSString stringWithFormat:<span style="color: teal;">@"</span><span style="color: teal;">%@</span>weather.php?<span style="font-weight: 700;">format</span>=xml<span style="color: rgb(221, 17, 68);">", BaseURLString];
    NSURL <span style="color: teal;">*url</span> = [NSURL URLWithString:string];
    NSURLRequest <span style="color: teal;">*request</span> = [NSURLRequest requestWithURL:url];

    AFHTTPRequestOperation <span style="color: teal;">*operation</span> = [[AFHTTPRequestOperation alloc] initWithRequest:request];

    // Make sure to set the responseSerializer correctly
    operation.responseSerializer = [AFXMLParserResponseSerializer serializer];

    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, id responseObject) {

        NSXMLParser <span style="color: teal;">*XMLParser</span> = (NSXMLParser <span style="color: teal;">*)</span>responseObject;
        [XMLParser setShouldProcessNamespaces:YES];

        // Leave these commented for now (you first need to add the delegate methods)
        // XMLParser.delegate = self;
        // [XMLParser parse];

    } failure:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, NSError <span style="color: teal;">*error</span>) {

        UIAlertView <span style="color: teal;">*alertView</span> = [[UIAlertView alloc] initWithTitle:<span style="color: teal;">@"</span>Error Retrieving Weather"</span>
                                                            message:[error localizedDescription]
                                                           delegate:nil
                                                  cancelButtonTitle:<span style="color: teal;">@"</span>Ok<span style="color: rgb(221, 17, 68);">"
                                                  otherButtonTitles:nil];
        [alertView show];

    }];

    [operation start];
}</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">代码看上去跟之前也很像，最大的变化就是在成功的block中，你不能很轻松的解析出NSDictory来。<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">responseObject</code>是一个<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">NSXMLParser</code>的实例。你会用它来完成繁重的XML解析任务。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">你需要一个对<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">NXMLParser</code>的代理进行设置才能解析XML,注意NXMLParser的代理设置为self。你增在WTTableViewController中增加NXMLParser的代理方法来解析XML.</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">首先，改变WTTableViewController.h 的类声明，像下面这样：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@interface WTTableViewController : UITableViewController&lt;NSXMLParserDelegate></code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这意味着类必须实现NSXMLParserDelegate的协议。你将会实现这些方法，但是在此之前，先增加几个属性。增加如下属性在<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WTTableViewController.m</code>的类的扩展中，就是<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@interface WTTableViewController () :</code>下面。</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;"><span style="color: teal;">@property</span>(nonatomic, strong) NSMutableDictionary <span style="color: teal;">*currentDictionary</span>;   <span style="color: rgb(0, 153, 38);">//</span> current section being parsed
<span style="color: teal;">@property</span>(nonatomic, strong) NSMutableDictionary <span style="color: teal;">*xmlWeather</span>;          <span style="color: rgb(0, 153, 38);">//</span> completed parsed xml response
<span style="color: teal;">@property</span>(nonatomic, strong) NSString <span style="color: teal;">*elementName</span>;
<span style="color: teal;">@property</span>(nonatomic, strong) NSMutableString <span style="color: teal;">*outstring</span>;</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这些属性会在解析XML的时候用到。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">现在复制代码到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WTTableViewController.m</code>中，就是<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@end</code>上面。</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (<span style="font-weight: 700;">void</span>)parserDidStartDocument:(NSXMLParser *)parser
{
    self.xmlWeather = [NSMutableDictionary dictionary];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">解析器调用这个方法在解析刚开始的时候，在这个方法里，给xmlWeather设置一个新的字典来持有XML数据。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">然后复制下面的代码到上一段代码后面：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (void)parser:(NSXMLParser <span style="color: teal;">*)</span>parser didStartElement:(NSString <span style="color: teal;">*)</span>elementName namespaceURI:(NSString <span style="color: teal;">*)</span>namespaceURI qualifiedName:(NSString <span style="color: teal;">*)</span>qName attributes:(NSDictionary <span style="color: teal;">*)</span>attributeDict
{
    self.elementName = qName;

    <span style="font-weight: 700;">if</span>([qName isEqualToString:<span style="color: teal;">@"</span>current_condition<span style="color: rgb(221, 17, 68);">"] ||
       [qName isEqualToString:<span style="color: teal;">@"</span>weather"</span>] ||
       [qName isEqualToString:<span style="color: teal;">@"</span>request<span style="color: rgb(221, 17, 68);">"]) {
        self.currentDictionary = [NSMutableDictionary dictionary];
    }

    self.outstring = [NSMutableString string];
}</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当解析器发现一个新的节点的开始标签的时候，会调用上面的方法。当被调用的时候，你把这个节点的名字赋值给<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">self.elementName</code>，如果这个节点是一个天气数据的开始，那么就给<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">self.currentDictionary</code>设置一个新的字典，最后，重置<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">self.outstring</code>，为接收相关联的节点做准备。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">复制下面的代码到上一段代码后面：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (<span style="font-weight: 700;">void</span>)parser:(NSXMLParser *)parser foundCharacters:(NSString *)<span style="font-weight: 700;">string</span>
{
    <span style="font-weight: 700;">if</span> (!self.elementName)
        <span style="font-weight: 700;">return</span>;

    [self.outstring appendFormat:<span style="color: rgb(221, 17, 68);">@"%@"</span>, <span style="font-weight: 700;">string</span>];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">正如名字按时的，解析器调用这个方法，会在XML节点中找到字符串，你会增加新的字符串在outstring中，所以XML可以被解析，知道XML标签结束。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">复制下面代码到上一段代码之后</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (void)parser:(NSXMLParser *)parser didEndElement:(NSString *)elementName namespaceURI:(NSString *)namespaceURI qualifiedName:(NSString *)qName
{
    <span style="color: rgb(153, 153, 136); font-style: italic;">// 1</span>
    <span style="font-weight: 700;">if</span> ([qName isEqualToString:@<span style="color: rgb(221, 17, 68);">"current_condition"</span>] ||
       [qName isEqualToString:@<span style="color: rgb(221, 17, 68);">"request"</span>]) {
        <span style="font-weight: 700;">self</span>.xmlWeather[qName] = @[<span style="font-weight: 700;">self</span>.currentDictionary];
        <span style="font-weight: 700;">self</span>.currentDictionary = nil;
    }
    <span style="color: rgb(153, 153, 136); font-style: italic;">// 2</span>
    <span style="font-weight: 700;">else</span> <span style="font-weight: 700;">if</span> ([qName isEqualToString:@<span style="color: rgb(221, 17, 68);">"weather"</span>]) {

        <span style="color: rgb(153, 153, 136); font-style: italic;">// Initialize the list of weather items if it doesn't exist</span>
        NSMutableArray *<span style="font-weight: 700;">array</span> = <span style="font-weight: 700;">self</span>.xmlWeather[@<span style="color: rgb(221, 17, 68);">"weather"</span>] ?: [NSMutableArray <span style="font-weight: 700;">array</span>];

        <span style="color: rgb(153, 153, 136); font-style: italic;">// Add the current weather object</span>
        [<span style="font-weight: 700;">array</span> addObject:<span style="font-weight: 700;">self</span>.currentDictionary];

        <span style="color: rgb(153, 153, 136); font-style: italic;">// Set the new array to the "weather" key on xmlWeather dictionary</span>
        <span style="font-weight: 700;">self</span>.xmlWeather[@<span style="color: rgb(221, 17, 68);">"weather"</span>] = <span style="font-weight: 700;">array</span>;

        <span style="font-weight: 700;">self</span>.currentDictionary = nil;
    }
    <span style="color: rgb(153, 153, 136); font-style: italic;">// 3</span>
    <span style="font-weight: 700;">else</span> <span style="font-weight: 700;">if</span> ([qName isEqualToString:@<span style="color: rgb(221, 17, 68);">"value"</span>]) {
        <span style="color: rgb(153, 153, 136); font-style: italic;">// Ignore value tags, they only appear in the two conditions below</span>
    }
    <span style="color: rgb(153, 153, 136); font-style: italic;">// 4</span>
    <span style="font-weight: 700;">else</span> <span style="font-weight: 700;">if</span> ([qName isEqualToString:@<span style="color: rgb(221, 17, 68);">"weatherDesc"</span>] ||
            [qName isEqualToString:@<span style="color: rgb(221, 17, 68);">"weatherIconUrl"</span>]) {
        NSDictionary *dictionary = @{@<span style="color: rgb(221, 17, 68);">"value"</span>: <span style="font-weight: 700;">self</span>.outstring};
        NSArray *<span style="font-weight: 700;">array</span> = @[dictionary];
        <span style="font-weight: 700;">self</span>.currentDictionary[qName] = <span style="font-weight: 700;">array</span>;
    }
    <span style="color: rgb(153, 153, 136); font-style: italic;">// 5</span>
    <span style="font-weight: 700;">else</span> <span style="font-weight: 700;">if</span> (qName) {
        <span style="font-weight: 700;">self</span>.currentDictionary[qName] = <span style="font-weight: 700;">self</span>.outstring;
    }

    <span style="font-weight: 700;">self</span>.elementName = nil;
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当你发现一个节点的结束标签时调用上面的方法，你可以在里面检查一些特殊标签：</p>
<ol style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">这个<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">current_condition</code>节点包含了当天的天气数据，你可以直接把他们加入xmlWeather字典中。</li>
<li style="line-height: 22px;">这个<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">weather</code>节点包含了随后的天气数据，天气数据只会包含一个当前天，可能会有几个未来天气，你需要把未来天气增加到array中。</li>
<li style="line-height: 22px;"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">value</code>标签不用处理，直接跳过。</li>
<li style="line-height: 22px;"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">weatherDesc</code>和<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">weatherIconUrl</code>节点在被保存之前需要被包含在一个array中，这个方法跟处理json和plist基本一样。</li>
<li style="line-height: 22px;">其他节点都像这样被保存。</li>
</ol>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">现在是最后一个代理方法了，把它复制到上一段后面：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (void) <span style="color: rgb(153, 0, 115);">parserDidEndDocument:</span>(NSXMLParser *)parser
{
    <span style="font-weight: 700;">self</span>.weather = @{@<span style="color: rgb(221, 17, 68);">"data"</span><span style="color: rgb(153, 0, 115);">:</span> <span style="font-weight: 700;">self</span>.xmlWeather};
    <span style="font-weight: 700;">self</span>.title = @<span style="color: rgb(221, 17, 68);">"XML Retrieved"</span>;
    [<span style="font-weight: 700;">self</span>.tableView reloadData];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当到了整个xml最后的时候，解析器调用这个方法。这时，xml就被完全解析完成，我们就可以加载列表数据了。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">xmlWeather被其他的字典包含可能有点多余，但是这样格式就跟json和plist相匹配了，用完全相同的代码就可以显示三种格式的数据了。 <img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/eb2ec04d53543f9cd8e0a9c475e00d6b.png" height="299" width="480"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">现在代理方法就都有了，回调<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">xmlTapped:</code>方法，解开注释的那几行，运行你的项目，会看到： <img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/cc80d478830a447d222977358de17716.png" height="500" width="352"/></p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">A Little Weather Flair</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这看起来有点枯燥，如果有几天是下雨，我们怎么才能在列表中多加入一些信息呢？ 另外，在<a href="http://www.raywenderlich.com/demos/weather_sample/weather.php?format=json" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">JSON format from before</a>中，我们发现在每个天气中有一些图片地址，如果显示天气图片可能会让我们的app看起来更有趣一些。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">AFNetworking 为 UIImageView增加了一个categry，让你可以异步加载图片。意味着UI会在图片后台下载的过程中保持响应。为了使用这个优势，在WTTableViewController.m中引入categry。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">#import "UIImageView+AFNetworking.h"</code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">找到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">tableView:cellForRowAtIndexPath:</code>方法，并且把下面代码复制到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">return cell;</code>之前（应该有一个注释标记点）。</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">cell.textLabel.text = [daysWeather weatherDescription];

    NSURL <span style="color: teal;">*url</span> = [NSURL URLWithString:daysWeather.weatherIconURL];
    NSURLRequest <span style="color: teal;">*request</span> = [NSURLRequest requestWithURL:url];
    UIImage <span style="color: teal;">*placeholderImage</span> = [UIImage imageNamed:<span style="color: teal;">@"</span>placeholder<span style="color: rgb(221, 17, 68);">"];

    __weak UITableViewCell <span style="color: teal;">*weakCell</span> = cell;

    [cell.imageView setImageWithURLRequest:request
                          placeholderImage:placeholderImage
                                   success:^(NSURLRequest <span style="color: teal;">*request</span>, NSHTTPURLResponse <span style="color: teal;">*response</span>, UIImage <span style="color: teal;">*image</span>) {

                                       weakCell.imageView.image = image;
                                       [weakCell setNeedsLayout];

                                   } failure:nil];</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">UIImageView+AFNetworking让<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">setImageWithURLRequest:</code>和一些其他方法都对你可用。成功和失败的block是可选的。如果你实现了成功的block，你就必须把image 设置给imageView的image属性，否则它不会自动设置。如果你没有实现成功的block，那么就会帮你自动设置。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当cell第一次生成的时候，imageView会显示占位图片，直到真正的图片被下载下来为止。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">现在运行你的项目，点击你已经增加的任何操作，你会看到如下：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/6ac20cd521dc366b48e10cc2fc2b8e85.png" height="500" width="352"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">太棒了，异步加载图片是前所未有的简单。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">A RESTful Class</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">迄今为止，我们已经用AFHTTPRequestOperation生成了一次性的网络请求。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">或者，AFHTTPRequestOperationManager 和 AFHTTPSessionManager被设计为帮助用户与单个的，网络节点交互起来更简单。这两个都可以设置一个base url，然后向网络节点做一些请求。他们都可以监控网络变化，编码参数，处理多线程请求，批处理队列操作，执行完整的一套基于restful的命令（GET, POST, PUT, and DELETE）。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">“我到底该用哪个？”你可能会问？</p>
<ul style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">如果是iOS7 或者以上，你可以用AFHTTPSessionManager，本质上，它是基于NSURLSession和相关对象的。</li>
<li style="line-height: 22px;">如果是iOS6，你可以用AFHTTPRequestOperationManager，它和AFHTTPSessionManager有相同的功能。只是它是基于NSURLConnection，而不是NSURLSession（iOS6没有这个类），其他方面，功能上都差不多。</li>
</ul>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在你的天气项目中，你需要使用AFHTTPSessionManager来执行GET,POST的任务。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">注意：不懂什么是（GET,POST,DELETE,PUT）你可以查看这个分类的解释--<a href="http://rest.elkstein.org/2008/02/what-is-rest.html" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">什么是restful</a>。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">更新WTTableViewController.h 中类的声明：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@interface WTTableViewController : UITableViewController&lt;NSXMLParserDelegate, CLLocationManagerDelegate, UIActionSheetDelegate></code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WTTableViewController.m</code>中，找到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">clientTapped:</code>方法，用下面代码替换实现：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (IBAction)clientTapped:(id)sender 
{
    UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:<span style="color: rgb(221, 17, 68);">@"AFHTTPSessionManager"</span>
                                                             <span style="font-weight: 700;">delegate</span>:self
                                                    cancelButtonTitle:<span style="color: rgb(221, 17, 68);">@"Cancel"</span>
                                               destructiveButtonTitle:nil
                                                    otherButtonTitles:<span style="color: rgb(221, 17, 68);">@"HTTP GET"</span>, <span style="color: rgb(221, 17, 68);">@"HTTP POST"</span>, nil];
    [actionSheet showFromBarButtonItem:sender animated:YES];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个方法生成和显示了一个UIActionSheet，用来让用户选择是GET 还是POST请求。在类的实现结尾（就是<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@end</code>上面）增加下面的这个UIActionSheetDelegate的实现方法。</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (<span style="font-weight: 700;">void</span>)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    <span style="font-weight: 700;">if</span> (buttonIndex == [actionSheet cancelButtonIndex]) {
        <span style="color: rgb(153, 153, 136); font-style: italic;">// User pressed cancel -- abort</span>
        <span style="font-weight: 700;">return</span>;
    }

    <span style="color: rgb(153, 153, 136); font-style: italic;">// 1</span>
    NSURL *baseURL = [NSURL URLWithString:BaseURLString];
    NSDictionary *parameters = @{<span style="color: rgb(221, 17, 68);">@"format"</span>: <span style="color: rgb(221, 17, 68);">@"json"</span>};

    <span style="color: rgb(153, 153, 136); font-style: italic;">// 2</span>
    AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc] initWithBaseURL:baseURL];
    manager.responseSerializer = [AFJSONResponseSerializer serializer];

    <span style="color: rgb(153, 153, 136); font-style: italic;">// 3</span>
    <span style="font-weight: 700;">if</span> (buttonIndex == <span style="color: rgb(0, 153, 153);">0</span>) {
        [manager GET:<span style="color: rgb(221, 17, 68);">@"weather.php"</span> parameters:parameters success:^(NSURLSessionDataTask *task, id responseObject) {
            self.weather = responseObject;
            self.title = <span style="color: rgb(221, 17, 68);">@"HTTP GET"</span>;
            [self.tableView reloadData];
        } failure:^(NSURLSessionDataTask *task, NSError *error) {
            UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:<span style="color: rgb(221, 17, 68);">@"Error Retrieving Weather"</span>
                                                                message:[error localizedDescription]
                                                               <span style="font-weight: 700;">delegate</span>:nil
                                                      cancelButtonTitle:<span style="color: rgb(221, 17, 68);">@"Ok"</span>
                                                      otherButtonTitles:nil];
            [alertView show];
        }];
    }

    <span style="color: rgb(153, 153, 136); font-style: italic;">// 4</span>
    <span style="font-weight: 700;">else</span> <span style="font-weight: 700;">if</span> (buttonIndex == <span style="color: rgb(0, 153, 153);">1</span>) {
        [manager POST:<span style="color: rgb(221, 17, 68);">@"weather.php"</span> parameters:parameters success:^(NSURLSessionDataTask *task, id responseObject) {
            self.weather = responseObject;
            self.title = <span style="color: rgb(221, 17, 68);">@"HTTP POST"</span>;
            [self.tableView reloadData];
        } failure:^(NSURLSessionDataTask *task, NSError *error) {
            UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:<span style="color: rgb(221, 17, 68);">@"Error Retrieving Weather"</span>
                                                                message:[error localizedDescription]
                                                               <span style="font-weight: 700;">delegate</span>:nil
                                                      cancelButtonTitle:<span style="color: rgb(221, 17, 68);">@"Ok"</span>
                                                      otherButtonTitles:nil];
            [alertView show];
        }];
    }
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">上面的代码做了这些事情：</p>
<ol style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">先设置了base url和参数的字典。</li>
<li style="line-height: 22px;">生成了一个AFHTTPSessionManager实例，设置它的反馈解析器为JSON，跟之前JSON的例子一样。</li>
<li style="line-height: 22px;">如果用户点击了HTTP GET的按钮，那么你就会用manager执行GET方法，传输参数，并实现成功和失败的block。</li>
<li style="line-height: 22px;">POST版本的代码跟上面一样。</li>
</ol>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在这个例子里面，你请求JSON数据，你也可以很轻松的获得其他两种格式的数据，就想我们之前讨论的。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">编译执行你的项目，点击app上面的clent按钮，分别选择HTTP GET和HTTP POST按钮，执行相应的任务。你可以看到下面的界面：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/75cfbee09f9a75470b1fb35414557f95.png" height="378" width="700"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">从这里，你可以了解使用AFHTTPSessionManager的基本方式。当然你可以知道更简洁的办法去获取请求，接下来我们会讲到。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">World Weather Online</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在你使用正式服务之前，你得先去<a href="http://developer.worldweatheronline.com/member/register" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;"> World Weather Online</a>注册一个账号，别担心，很快很简单。你注册之后，会收到一封确认邮件。你可以在账号页面上面找到一个请求时需要的api key，让我们带着key继续,你很快会用到的。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">Hooking into the Live Service</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">到目前为止，我们已经在列表视图控制器上面创建了 AFHTTPRequestOperation 和 AFHTTPSessionManager ，更多的时候，你的网络请求会有一个单个的web接口生成。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">AFHTTPSessionManager可以帮你做请求API的所有事情。它可以把网络交互代码从其他代码中解耦出来，使其应用于项目的其他部分中。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这里有两个针对AFHTTPSessionManager的最佳实践：</p>
<ol style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">给每个web服务生成一个单独子类。如果你要写一个社交聚合器，那么你可能需要为Twitter写一个类，为Facebook写一个，为Instragram写一个，等等。</li>
<li style="line-height: 22px;">在每个AFHTTPSessionManager子类中，生成一个静态方法，返回一个实例，它用来保存资源，而不是每次都生成一个新的对象。</li>
</ol>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">如果你的项目没有这个AFHTTPSessionManager的子类，那么生成一个解决它。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">我们先在你的项目中创建一个新的Objective-c类型的类，叫WeatherHTTPClient，是AFHTTPSessionManager的子类。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个类做三件事：执行HTTP请求，当天气数据返回的时候，处理代理的回调，用用户的当前位置，获得正确的天气数据。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">用下面的代码替换WeatherHTTPClient.h的内容：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;"><span style="color: rgb(153, 153, 136); font-style: italic;">#import "AFHTTPSessionManager.h"</span>

<span style="color: teal;">@protocol</span> WeatherHTTPClientDelegate;

<span style="color: teal;">@interface</span> WeatherHTTPClient : AFHTTPSessionManager
<span style="color: teal;">@property</span> (nonatomic, weak) id&lt;WeatherHTTPClientDelegate>delegate;

+ (WeatherHTTPClient <span style="color: teal;">*)</span>sharedWeatherHTTPClient;
- (instancetype)initWithBaseURL:(NSURL <span style="color: teal;">*)</span>url;
- (void)updateWeatherAtLocation:(CLLocation <span style="color: teal;">*)</span>location forNumberOfDays:(NSUInteger)number;

<span style="color: teal;">@end</span>

<span style="color: teal;">@protocol</span> WeatherHTTPClientDelegate &lt;NSObject>
<span style="color: teal;">@optional</span>
-(void)weatherHTTPClient:(WeatherHTTPClient <span style="color: teal;">*)</span>client didUpdateWithWeather:(id)weather;
-(void)weatherHTTPClient:(WeatherHTTPClient <span style="color: teal;">*)</span>client didFailWithError:(NSError <span style="color: teal;">*)</span>error;
<span style="color: teal;">@end</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">你将会学习每个方法的实现，改变WeatherHTTPClient.m，把下面内容增加到import下面：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;"><span style="color: rgb(153, 153, 136); font-style: italic;">// Set this to your World Weather Online API Key</span>
<span style="font-weight: 700;">static</span> NSString * <span style="font-weight: 700;">const</span> WorldWeatherOnlineAPIKey = <span style="color: rgb(221, 17, 68);">@"PASTE YOUR API KEY HERE"</span>;

<span style="font-weight: 700;">static</span> NSString * <span style="font-weight: 700;">const</span> WorldWeatherOnlineURLString = <span style="color: rgb(221, 17, 68);">@"<a href="http://api.worldweatheronline.com/free/v1/">http://api.worldweatheronline.com/free/v1/</a>"</span>;</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">一定要确保把<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@"PASTE YOUR API KEY HERE"</code>替换成你刚获得的Api Key，然后把下面的代码复制到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@implementation</code>这一行下面：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">+ (WeatherHTTPClient *)sharedWeatherHTTPClient
{
    static WeatherHTTPClient *_sharedWeatherHTTPClient = <span style="font-weight: 700;">nil</span>;

    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        _sharedWeatherHTTPClient = [[<span style="font-weight: 700;">self</span> alloc] <span style="color: rgb(153, 0, 115);">initWithBaseURL:</span>[NSURL URLWithString<span style="color: rgb(153, 0, 115);">:WorldWeatherOnlineURLString</span>]];
    });

    <span style="font-weight: 700;">return</span> _sharedWeatherHTTPClient;
}

- (instancetype)<span style="color: rgb(153, 0, 115);">initWithBaseURL:</span>(NSURL *)url
{
    <span style="font-weight: 700;">self</span> = [<span style="font-weight: 700;">super</span> <span style="color: rgb(153, 0, 115);">initWithBaseURL:</span>url];

    <span style="font-weight: 700;">if</span> (<span style="font-weight: 700;">self</span>) {
        <span style="font-weight: 700;">self</span>.responseSerializer = [AFJSONResponseSerializer serializer];
        <span style="font-weight: 700;">self</span>.requestSerializer = [AFJSONRequestSerializer serializer];
    }

    <span style="font-weight: 700;">return</span> <span style="font-weight: 700;">self</span>;
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">sharedWeatherHTTPClient这个方法用GCD的方式确保了单例模式生成的实例只被创建一次，你用base url 创建了这个对象，并且设置将要从web服务获取到的response为JSON格式。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">复制下面的代码，复制到上一段代码下面：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (void)updateWeatherAtLocation:(CLLocation <span style="color: teal;">*)</span>location forNumberOfDays:(NSUInteger)number
{
    NSMutableDictionary <span style="color: teal;">*parameters</span> = [NSMutableDictionary dictionary];

    parameters[<span style="color: teal;">@"</span>num_of_days<span style="color: rgb(221, 17, 68);">"] = <span style="color: teal;">@(</span>number);
    parameters[<span style="color: teal;">@"</span>q"</span>] = [NSString stringWithFormat:<span style="color: teal;">@"</span><span style="color: teal;">%f</span>,<span style="color: teal;">%f</span><span style="color: rgb(221, 17, 68);">",location.coordinate.latitude,location.coordinate.longitude];
    parameters[<span style="color: teal;">@"</span>format"</span>] = <span style="color: teal;">@"</span>json<span style="color: rgb(221, 17, 68);">";
    parameters[<span style="color: teal;">@"</span>key"</span>] = WorldWeatherOnlineAPIKey;

    [self GET:<span style="color: teal;">@"</span>weather.ashx<span style="color: rgb(221, 17, 68);">" parameters:parameters success:^(NSURLSessionDataTask <span style="color: teal;">*task</span>, id responseObject) {
        if ([self.delegate respondsToSelector:<span style="color: teal;">@selector</span>(weatherHTTPClient:didUpdateWithWeather:)]) {
            [self.delegate weatherHTTPClient:self didUpdateWithWeather:responseObject];
        }
    } failure:^(NSURLSessionDataTask <span style="color: teal;">*task</span>, NSError <span style="color: teal;">*error</span>) {
        if ([self.delegate respondsToSelector:<span style="color: teal;">@selector</span>(weatherHTTPClient:didFailWithError:)]) {
            [self.delegate weatherHTTPClient:self didFailWithError:error];
        }
    }];
}</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个方法为特殊的地理位置获得相应的天气数据。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">自从这个对象加载了天气数据，就得有一些方法把数据传递给那些数据其感兴趣的对象。感谢WeatherHTTPClientDelegate协议，和它的代理方法，成功和失败的block就可以通知一个控制器，和地理位置相关的天气数据已经被更新了，用这种方式，控制器就可以更新成它想显示的东西。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">到时候写出最后的代码了，WeatherHTTPClient为了获得一个地理位置，需要定义一个代理协议，所以你需要更新WTTableViewController。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">打开<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WTTableViewController.h</code>，你需要增加一个导入，用下面的代码替换<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@interface</code>的声明：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">#import "WeatherHTTPClient.h"

@interface WTTableViewController : UITableViewController <span style="color: navy;">&lt;NSXMLParserDelegate, <span style="color: teal;">CLLocationManagerDelegate</span>, <span style="color: teal;">UIActionSheetDelegate</span>, <span style="color: teal;">WeatherHTTPClientDelegate</span>]]
<![CDATA[>]]>
</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">增加一个新的Core Location manager属性：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">@property (nonatomic, strong) CLLocationManager *locationManager;</code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WTTableViewController.m</code>，从<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">viewDidLoad:</code>最下面增加下面几行：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;"><span style="font-weight: 700;">self</span>.locationManager = [[CLLocationManager alloc] init];
<span style="font-weight: 700;">self</span>.locationManager.delegate = <span style="font-weight: 700;">self</span>;</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这几行在创建了Core Location manager，并且在视图加载的时候，获取地理位置。 Core Location manager通过代理回调来报告地理位置信息。下面是方法实现：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (<span style="font-weight: 700;">void</span>)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray *)locations
{
    <span style="color: rgb(153, 153, 136); font-style: italic;">// Last object contains the most recent location</span>
    CLLocation *newLocation = [locations lastObject];

    <span style="color: rgb(153, 153, 136); font-style: italic;">// If the location is more than 5 minutes old, ignore it</span>
    <span style="font-weight: 700;">if</span>([newLocation.timestamp timeIntervalSinceNow] > <span style="color: rgb(0, 153, 153);">300</span>)
        <span style="font-weight: 700;">return</span>;

    [self.locationManager stopUpdatingLocation];

    WeatherHTTPClient *client = [WeatherHTTPClient sharedWeatherHTTPClient];
    client.<span style="font-weight: 700;">delegate</span> = self;
    [client updateWeatherAtLocation:newLocation forNumberOfDays:<span style="color: rgb(0, 153, 153);">5</span>];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当用户的位置有变化的时候，你就能调用WeatherHTTPClient 的单例方法，通过这个地理位置来请求天气数据了。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">WeatherHTTPClient有两个代理方法，需要你来实现，增加下面两个方法的实现：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (void)weatherHTTPClient:(WeatherHTTPClient <span style="color: teal;">*)</span>client didUpdateWithWeather:(id)weather
{
    self.weather = weather;
    self.title = <span style="color: teal;">@"</span>API Updated<span style="color: rgb(221, 17, 68);">";
    [self.tableView reloadData];
}

- (void)weatherHTTPClient:(WeatherHTTPClient <span style="color: teal;">*)</span>client didFailWithError:(NSError <span style="color: teal;">*)</span>error
{
    UIAlertView <span style="color: teal;">*alertView</span> = [[UIAlertView alloc] initWithTitle:<span style="color: teal;">@"</span>Error Retrieving Weather"</span>
                                                        message:[NSString stringWithFormat:<span style="color: teal;">@"</span><span style="color: teal;">%@</span><span style="color: rgb(221, 17, 68);">",error]
                                                       delegate:nil
                                              cancelButtonTitle:<span style="color: teal;">@"</span>OK"</span> otherButtonTitles:nil];
    [alertView show];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当WeatherHTTPClient请求成功，你可以更新天气数据，重新载入列表视图。如果网络错误，那显示错误信息。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">找到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">apiTapped:</code>方法，用下面代码替换其实现：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (IBAction)<span style="color: rgb(153, 0, 115);">apiTapped:</span>(id)sender
{
    [<span style="font-weight: 700;">self</span>.locationManager startUpdatingLocation];
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">编译运行你的项目（如果模拟器有问题的话，尝试用你的设备）点击API按钮，创建WeatherHTTPClient请求，你将会看到一下界面：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/6d4e1b228423d89fba99735eab79f79a.png" height="500" width="352"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">希望你未来的天气是晴天，就像我这里一样。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">I’m Not Dead Yet!</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">你可能注意到一段时间之后数据才会返回，在进行网络请求的时候，给用户一些反馈是很重要的，让他们知道app并没有挂掉。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/5573107c18bb3f88b1de4ff08ff8ada6.png" height="177" width="480"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">幸运的是AFNetworking 提供了一个非常简单的办法来提供这个反馈：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">AFNetworkActivityIndicatorManager</code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WTAppDelegate.m</code>中增加一个新的导入文件：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">#import "AFNetworkActivityIndicatorManager.h"</code></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">然后找到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">application:didFinishLaunchingWithOptions:</code>这个方法用下面的代码替换：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (BOOL)application:(UIApplication <span style="color: teal;">*)</span>application didFinishLaunchingWithOptions:(NSDictionary <span style="color: teal;">*)</span>launchOptions
{
    [AFNetworkActivityIndicatorManager sharedManager].enabled = YES;
    <span style="font-weight: 700;">return</span> YES;
}</code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">当后台有网络请求的时候，sharedManager讲自动显示网络活动显示器，你不需要分别为每个请求去处理它。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">编译运行你的项目，如果有网络请求的时候，你会看到在状态栏上面，有一个小的网络菊花（这么翻译会不会太恶俗了:)）。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/c7b842d738a7ec0e1999958bf0224fde.png" height="35" width="330"/></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">现在当app等待一个缓慢的网络服务的时候，你给用户提供了一个生命迹象。</p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">Downloading Images</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">如果你点击列表的每一行，app会提供一个天气的详细页面，用动画的方式显示了当前的天气。 很棒，现在动画有了一个简单的背景，有什么更好的方式来更新背景呢？这就是我们这个教程中介绍AFNetworking的最后一招。AFHTTPRequestOperation可以通过设置responseSerializer为一个AFImageResponseSerializer实例来处理图片。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">有两个方法在<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WeatherAnimationViewController.m</code>中被实现，找到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">updateBackgroundImage:</code>方法，用下面代码替换：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (IBAction)updateBackgroundImage:(id)sender
{
    NSURL <span style="color: teal;">*url</span> = [NSURL URLWithString:<span style="color: teal;">@"</span>http:<span style="color: rgb(0, 153, 38);">//www</span>.<a href="http://raywenderlich.com/wp-content/uploads/">raywenderlich.com/wp-content/uploads/</a><span style="color: rgb(0, 153, 153);">2014</span>/<span style="color: rgb(0, 153, 153);">01</span>/sunny-background.png<span style="color: rgb(221, 17, 68);">"];
    NSURLRequest <span style="color: teal;">*request</span> = [NSURLRequest requestWithURL:url];

    AFHTTPRequestOperation <span style="color: teal;">*operation</span> = [[AFHTTPRequestOperation alloc] initWithRequest:request];
    operation.responseSerializer = [AFImageResponseSerializer serializer];

    [operation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, id responseObject) {

        self.backgroundImageView.image = responseObject;
        [self saveImage:responseObject withFilename:<span style="color: teal;">@"</span>background.png"</span>];

    } failure:^(AFHTTPRequestOperation <span style="color: teal;">*operation</span>, NSError <span style="color: teal;">*error</span>) {

        NSLog(<span style="color: teal;">@"</span>Error: <span style="color: teal;">%@</span><span style="color: rgb(221, 17, 68);">", error);
    }];

    [operation start];
}</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个方法就是在后台处理下载任务。完成后，将会返回完整的图片。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">在<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">WeatherAnimationViewController.m</code>您会看到两个帮助方法。<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">imageWithFilename:</code>和<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">saveImage:withFilename:</code>，他们帮助我们储存和下载图片文件。<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">updateBackgroundImage:</code>帮助我们将图片储存到硬盘中。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">找到<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 3px 4px; font-size: 12px; color: rgb(221, 17, 68); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">deleteBackgroundImage:</code>方法，替换相应的代码：</p>
<pre style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; word-wrap: break-word; padding: 9.5px; font-size: 12px; color: rgb(68, 68, 68); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; line-height: 20px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.148438); white-space: pre-wrap; word-break: break-all;">
<code style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; padding: 0.5em; color: rgb(51, 51, 51); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-color: rgb(248, 248, 255); border: 0px;">- (IBAction)deleteBackgroundImage:(id)sender
{
    NSArray <span style="color: teal;">*paths</span> = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
    NSString <span style="color: teal;">*path</span> = [[paths objectAtIndex:<span style="color: rgb(0, 153, 153);">0</span>] stringByAppendingPathComponent:<span style="color: teal;">@"</span>WeatherHTTPClientImages/<span style="color: rgb(221, 17, 68);">"];

    NSError <span style="color: teal;">*error</span> = nil;
    [[NSFileManager defaultManager] removeItemAtPath:path error:&amp;error];

    NSString <span style="color: teal;">*desc</span> = [self.weatherDictionary weatherDescription];
    [self start:desc];
}</span></code>
</pre>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">这个方法可以删除图片文件，让你可以再次下载图片来测试程序。</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">最后，运行项目，下载天气数据，点击列表的一行，进入详细页，从这里，点击更新按钮，如果你选择的是晴天，那么你将会看到下面的界面：</p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);"><img src="https://raw.github.com/Qpai/Qpai.github.io/master/_images/134ff62e3452eb08e4e78c6065ad1b00.png" height="500" width="352"/></p>
<h2 style="color: rgb(68, 68, 68); text-rendering: optimizelegibility; font-size: 24px; line-height: 40px; font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace;">Where To Go From Here?</h2>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">你可以下载完整的项目从<a href="http://cdn3.raywenderlich.com/wp-content/uploads/2014/01/Weather_Final.zip" target="_blank" style="color: rgb(85, 26, 139); text-decoration: none;">这里</a></p>
<p style="font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px; color: rgb(68, 68, 68);">所有的这些方法让你使用AFNetworking和外面的世界交互了。</p>
<ol style="padding: 0px; list-style-position: initial; list-style-image: initial; color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">
<li style="line-height: 22px;">AFHTTPOperation 、 AFJSONResponseSerializer、 AFPropertyListResponseSerializer、 AFXMLParserResponseSerializer 这些解析器用来解析返回数据的结构。</li>
<li style="line-height: 22px;">UIImageView+AFNetworking快速填充图片视图。</li>
<li style="line-height: 22px;">自定义AFHTTPSessionManager子类去处理在线Web服务。</li>
<li style="line-height: 22px;">AFNetworkActivityIndicatorManager保持用户通知。</li>
<li style="line-height: 22px;">AFHTTPOperation 和 AFImageResponseSerializer是你处理图片请求的强大力量。</li>
</ol>
<span style="color: rgb(68, 68, 68); font-family: Monaco, Menlo, 'Ubuntu Mono', Consolas, source-code-pro, SimSun, Song, 宋体, 幼圆, Heiti, 黑体, 文泉驿等宽正黑, 文泉驿正黑, monospace; font-size: 13px; line-height: 20px;">如果你有任何问题，请访问论坛获取帮助，当然，我也很高兴看到你的评论。</span>
</body></html>
    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#翻译-ref">
    		翻译 <span>1</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#AFNetworking-ref">AFNetworking <span>1</span></a></li>
     
    	<li><a href="/tags.html#ios-ref">ios <span>3</span></a></li>
     
    	<li><a href="/tags.html#blog-ref">blog <span>3</span></a></li>
     
    	<li><a href="/tags.html#developer-ref">developer <span>2</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/other/2014/02/26/hello-world" title="Hello World">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2014/02/28/%E7%94%A8Cocoapod%E6%A8%A1%E5%9D%97%E5%8C%96%E5%A4%A7%E5%9E%8BiOS%E5%BA%94%E7%94%A8" title="用cocoapod模块化大型ios应用">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'Qpai'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2014 Qpai
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

